<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DAMAC Project</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  html, body { margin:0; height:100%; font-family:Arial, sans-serif; }
  h1 { text-align:center; margin:10px 0; color:#000; }
  #map { height:calc(100% - 50px); width:100%; display:none; }
  .login-container, .no-token {
    height:100%; display:flex; flex-direction:column;
    align-items:center; justify-content:center; text-align:center;
    padding:20px; box-sizing:border-box;
  }
  .login-container img, .no-token img { width:120px; max-width:40%; margin-bottom:20px; }
  .login-container input {
    padding:12px; margin:8px 0; width:100%; max-width:300px;
    font-size:16px; border-radius:5px; border:1px solid #ccc;
  }
  .login-container button {
    padding:12px 20px; font-size:16px; cursor:pointer;
    border:none; border-radius:5px; background-color:#007BFF; color:white;
    margin-top:10px; width:100%; max-width:300px;
  }
  .login-container button:hover { background-color:#0056b3; }
  #loginError { color:red; margin-top:10px; }
  #info {
    position:absolute; top:60px; left:10px;
    background:white; padding:10px; border-radius:5px; z-index:1000;
  }
</style>
</head>
<body>

<h1>DAMAC Project</h1>

<div class="login-container" id="loginDiv">
  <img src="https://github.com/RMB-DMAC-JAKE-001/locator-site/blob/main/RMB%20X%20DAMAC.png?raw=true" alt="RMB Logo">
  <input type="text" id="username" placeholder="Username">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p id="loginError"></p>
</div>

<div id="map"></div>
<div id="info"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const correctUser = "damac";
const correctPass = "12345";

let map, truckMarker, userMarker, line, sid;
let truckData = {lat:25.276987, lon:55.296249, name:"Truck"}; // placeholder

// ===== Wialon SID =====
async function getSID(token){
  const res = await fetch(`https://hst-api.wialon.com/wialon/ajax.html?svc=token/login&params={"token":"${token}"}`);
  const data = await res.json();
  if(data.eid) return data.eid;
  throw new Error("Failed to get session ID");
}

// ===== Truck position =====
async function fetchTruckPosition(sid){
  const url = `https://hst-api.wialon.com/wialon/ajax.html?svc=core/search_items&params={"spec":{"itemsType":"avl_unit","propName":"sys_name","propValueMask":"*","sortType":"sys_name"},"force":1,"flags":1,"from":0,"to":0}&sid=${sid}`;
  const res = await fetch(url);
  const data = await res.json();
  if(data.items && data.items.length>0){
    const pos = data.items[0].pos || {x:25.276987,y:55.296249};
    truckData = {lat:pos.y, lon:pos.x, name:data.items[0].nm};
  }
}

// ===== Distance & ETA =====
function haversine(lat1, lon1, lat2, lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

function updateInfo(userLat, userLon){
  const distance = haversine(userLat,userLon,truckData.lat,truckData.lon).toFixed(2);
  const speed = 50; // km/h
  const eta = (distance/speed).toFixed(2);
  document.getElementById("info").innerText = `Truck: ${truckData.name} | Distance: ${distance} km | ETA: ${eta} hours`;
}

// ===== Move truck smoothly =====
function moveMarker(marker,newLat,newLon,duration=2000){
  const start=marker.getLatLng();
  const deltaLat=newLat-start.lat;
  const deltaLon=newLon-start.lng;
  const steps=50;
  let i=0;
  const interval=duration/steps;
  const move=setInterval(()=>{
    i++;
    const lat=start.lat + deltaLat*(i/steps);
    const lon=start.lng + deltaLon*(i/steps);
    marker.setLatLng([lat,lon]);
    if(i>=steps) clearInterval(move);
  },interval);
}

// ===== Update map =====
function updateMap(userLat,userLon){
  if(!truckMarker) truckMarker=L.marker([truckData.lat,truckData.lon]).addTo(map).bindPopup(truckData.name);
  else moveMarker(truckMarker,truckData.lat,truckData.lon,4000);

  if(!userMarker) userMarker=L.marker([userLat,userLon]).addTo(map).bindPopup("Your Location").openPopup();
  else userMarker.setLatLng([userLat,userLon]);

  if(line) map.removeLayer(line);
  line=L.polyline([[truckData.lat,truckData.lon],[userLat,userLon]],{color:'red'}).addTo(map);

  map.fitBounds([[truckData.lat,truckData.lon],[userLat,userLon]],{padding:[50,50]});
}

// ===== Refresh every 45s =====
async function refresh(){
  const params = new URLSearchParams(window.location.search);
  const token = params.get("t");
  if(!token) return alert("Token missing");

  try{
    sid = await getSID(token);
    await fetchTruckPosition(sid);
    navigator.geolocation.getCurrentPosition(pos=>{
      const userLat = pos.coords.latitude;
      const userLon = pos.coords.longitude;
      updateMap(userLat,userLon);
      updateInfo(userLat,userLon);
    }, err=>{ alert("Could not get your location"); });
  }catch(e){ alert("Error: "+e.message); }
}

// ===== Login =====
function login(){
  const user = document.getElementById("username").value;
  const pass = document.getElementById("password").value;
  if(user===correctUser && pass===correctPass){
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("map").style.display="block";
    map=L.map('map').setView([25.276987,55.296249],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

    refresh(); // first load
    setInterval(refresh,45000); // every 45 seconds
  } else{
    document.getElementById("loginError").innerText="Invalid username or password!";
  }
}
</script>

</body>
</html>
